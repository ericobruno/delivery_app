<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-0">
      <i class="fas fa-shopping-cart text-primary"></i>
      Pedidos
    </h1>
    <p class="text-muted mb-0">
      Total: <%= @orders.count %> pedidos
      <% if Setting.scheduling_enabled? %>
        | <span class="badge bg-info">
          <i class="fas fa-calendar"></i>
          <%= @orders.where.not(scheduled_for: nil).count %> agendados
        </span>
      <% end %>
    </p>
  </div>
  <div>
    <%= link_to new_admin_order_path, class: 'btn btn-primary' do %>
      <i class="fas fa-plus"></i> Novo Pedido
    <% end %>
  </div>
</div>

<!-- Filtros -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <div class="row">
      <div class="col-md-3">
        <label class="form-label fw-bold">
          <i class="fas fa-filter"></i> Status
        </label>
        <select class="form-select" id="statusFilter">
          <option value="">Todos</option>
          <option value="novo">Novo</option>
          <option value="ag_aprovacao">Aguardando Aprovação</option>
          <option value="producao">Em Produção</option>
          <option value="pronto">Pronto</option>
          <option value="entregue">Entregue</option>
          <option value="cancelado">Cancelado</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">
          <i class="fas fa-calendar"></i> Agendamento
        </label>
        <select class="form-select" id="schedulingFilter">
          <option value="">Todos</option>
          <option value="scheduled">Agendados</option>
          <option value="not_scheduled">Não Agendados</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">
          <i class="fas fa-search"></i> Buscar
        </label>
        <input type="text" class="form-control" id="searchInput" placeholder="ID, cliente...">
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-outline-secondary" onclick="clearFilters()">
          <i class="fas fa-times"></i> Limpar Filtros
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Tabela de Pedidos -->
<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0" id="ordersTable">
        <thead class="table-dark">
          <tr>
            <th style="width: 80px;">ID</th>
            <th style="width: 200px;">Cliente</th>
            <th style="width: 120px;">Status</th>
            <th style="width: 150px;">Agendamento</th>
            <th style="width: 120px;">Total</th>
            <th style="width: 200px;">Ações</th>
          </tr>
        </thead>
        <tbody>
          <% @orders.each do |order| %>
            <tr class="order-row" 
                data-status="<%= order.status %>"
                data-scheduled="<%= order.scheduled_for.present? ? 'scheduled' : 'not_scheduled' %>"
                data-search="<%= order.id.to_s + ' ' + (order.customer&.name || '').downcase %>">
              <td>
                <span class="fw-bold text-primary">#<%= order.id %></span>
              </td>
              <td>
                <div>
                  <i class="fas fa-user text-muted"></i>
                  <%= order.customer&.name %>
                </div>
                <% if order.description.present? %>
                  <small class="text-muted">
                    <i class="fas fa-file-alt"></i>
                    <%= truncate(order.description, length: 40) %>
                  </small>
                <% end %>
              </td>
              <td>
                <% status_colors = {
                  'novo' => 'secondary',
                  'ag_aprovacao' => 'warning',
                  'producao' => 'info',
                  'pronto' => 'success',
                  'entregue' => 'primary',
                  'cancelado' => 'danger'
                } %>
                <span class="badge bg-<%= status_colors[order.status] || 'secondary' %>">
                  <i class="fas fa-tag"></i>
                  <%= order.status.humanize %>
                </span>
              </td>
              <td>
                <% if order.scheduled_for.present? %>
                  <div class="d-flex align-items-center">
                    <span class="badge bg-info me-2">
                      <i class="fas fa-calendar-alt"></i>
                      <%= order.scheduled_for.strftime("%d/%m") %>
                    </span>
                    <div>
                      <div class="fw-bold">
                        <i class="fas fa-clock text-primary"></i>
                        <%= order.scheduled_for.strftime("%H:%M") %>
                      </div>
                      <% if order.scheduled_notes.present? %>
                        <small class="text-muted d-block">
                          <i class="fas fa-sticky-note"></i>
                          <%= truncate(order.scheduled_notes, length: 25) %>
                        </small>
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <span class="text-muted">
                    <i class="fas fa-minus"></i> Não agendado
                  </span>
                <% end %>
              </td>
              <td>
                <span class="fw-bold text-success">
                  R$ <%= number_to_currency(order.order_items.sum { |item| item.price.to_f * item.quantity }, unit: '', separator: ',', delimiter: '.') %>
                </span>
                <br>
                <small class="text-muted">
                  <%= pluralize(order.order_items.count, 'item') %>
                </small>
              </td>
              <td>
                <div class="btn-group" role="group">
                  <%= link_to admin_order_path(order), class: 'btn btn-sm btn-outline-primary', title: 'Ver detalhes' do %>
                    <i class="fas fa-eye"></i>
                  <% end %>
                  <%= link_to edit_admin_order_path(order), class: 'btn btn-sm btn-outline-secondary', title: 'Editar' do %>
                    <i class="fas fa-edit"></i>
                  <% end %>
                  <%= link_to admin_order_path(order), 
                      method: :delete, 
                      class: 'btn btn-sm btn-outline-danger', 
                      title: 'Excluir',
                      data: { 
                        confirm: 'Tem certeza que deseja excluir este pedido?',
                        turbo: false
                      } do %>
                    <i class="fas fa-trash"></i>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Filtros da tabela
document.getElementById('statusFilter').addEventListener('change', filterOrders);
document.getElementById('schedulingFilter').addEventListener('change', filterOrders);
document.getElementById('searchInput').addEventListener('input', filterOrders);

function filterOrders() {
  const statusFilter = document.getElementById('statusFilter').value;
  const schedulingFilter = document.getElementById('schedulingFilter').value;
  const searchInput = document.getElementById('searchInput').value.toLowerCase();
  
  const rows = document.querySelectorAll('.order-row');
  
  rows.forEach(row => {
    const status = row.dataset.status;
    const scheduled = row.dataset.scheduled;
    const search = row.dataset.search;
    
    const statusMatch = !statusFilter || status === statusFilter;
    const schedulingMatch = !schedulingFilter || scheduled === schedulingFilter;
    const searchMatch = !searchInput || search.includes(searchInput);
    
    if (statusMatch && schedulingMatch && searchMatch) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function clearFilters() {
  document.getElementById('statusFilter').value = '';
  document.getElementById('schedulingFilter').value = '';
  document.getElementById('searchInput').value = '';
  filterOrders();
}
</script>
