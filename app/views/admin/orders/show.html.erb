<div class="card mb-3 shadow-sm">
  <div class="card-header bg-primary text-white">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="card-title mb-0">
          <i class="fas fa-shopping-cart"></i>
          Pedido #<%= @order.id %>
        </h2>
        <h6 class="card-subtitle mb-0 text-white-50">
          <i class="fas fa-user"></i>
          Cliente: <%= @order.customer&.name %>
        </h6>
      </div>
      <div>
        <span class="badge bg-light text-dark fs-6">
          <i class="fas fa-tag"></i>
          <%= @order.status.humanize %>
        </span>
      </div>
    </div>
  </div>
  
  <div class="card-body">
    <!-- Informações de Agendamento -->
    <% if @order.scheduled_for.present? %>
      <div class="alert alert-info border-0 shadow-sm">
        <div class="row">
          <div class="col-md-8">
            <h6 class="alert-heading">
              <i class="fas fa-calendar-alt text-primary"></i>
              <strong>Pedido Agendado</strong>
            </h6>
            <div class="row">
              <div class="col-md-6">
                <p class="mb-1">
                  <i class="fas fa-clock"></i>
                  <strong>Data/Hora:</strong><br>
                  <span class="fs-5 fw-bold text-primary">
                    <%= @order.scheduled_for.strftime("%d/%m/%Y às %H:%M") %>
                  </span>
                </p>
              </div>
              <div class="col-md-6">
                <% scheduling_service = OrderSchedulingService.new %>
                <% if scheduling_service.validate_scheduling_time(@order.scheduled_for) %>
                  <span class="badge bg-success fs-6">
                    <i class="fas fa-check-circle"></i> Horário Disponível
                  </span>
                <% else %>
                  <span class="badge bg-warning fs-6">
                    <i class="fas fa-exclamation-triangle"></i> Horário Indisponível
                  </span>
                <% end %>
              </div>
            </div>
            
            <% if @order.scheduled_notes.present? %>
              <div class="mt-2">
                <i class="fas fa-sticky-note"></i>
                <strong>Observações:</strong><br>
                <span class="text-muted"><%= @order.scheduled_notes %></span>
              </div>
            <% end %>
          </div>
          <div class="col-md-4 text-end">
            <% if @order.can_be_cancelled? %>
              <%= link_to cancel_scheduled_order_admin_order_path(@order), 
                  method: :post, 
                  class: 'btn btn-warning btn-sm',
                  data: { 
                    confirm: 'Tem certeza que deseja cancelar este agendamento?',
                    turbo: false
                  } do %>
                <i class="fas fa-ban"></i> Cancelar Agendamento
              <% end %>
            <% else %>
              <div class="alert alert-secondary mb-0">
                <i class="fas fa-lock"></i>
                <small>Cancelamento não permitido</small>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- Descrição do Pedido -->
    <% if @order.description.present? %>
      <div class="alert alert-light border">
        <h6 class="alert-heading">
          <i class="fas fa-file-alt"></i>
          <strong>Descrição do Pedido</strong>
        </h6>
        <p class="mb-0"><%= @order.description %></p>
      </div>
    <% end %>
    <h5 class="mt-4">Itens do Pedido</h5>
    <table class="table table-sm table-bordered">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Adicionais</th>
          <th>Quantidade</th>
          <th>Preço</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody>
        <% @order.order_items.each do |item| %>
          <tr>
            <td><%= item.product&.name %></td>
            <td>
              <% if item.additional_products.any? %>
                <ul class="mb-0 ps-3">
                  <% item.additional_products.each do |ad| %>
                    <li>
                      <%= ad.name %>
                      <% if ad.price.present? && ad.price > 0 %>
                        (R$ <%= number_to_currency(ad.price, unit: '', separator: ',', delimiter: '.') %>)
                      <% end %>
                    </li>
                  <% end %>
                </ul>
              <% else %>
                <span class="text-muted">Nenhum</span>
              <% end %>
            </td>
            <td><%= item.quantity %></td>
            <td>R$ <%= number_to_currency(item.price, unit: '', separator: ',', delimiter: '.') %></td>
            <td>R$ <%= number_to_currency(item.price.to_f * item.quantity, unit: '', separator: ',', delimiter: '.') %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <div class="fw-bold">Total: R$ <%= number_to_currency(@order.order_items.sum { |item| item.price.to_f * item.quantity }, unit: '', separator: ',', delimiter: '.') %></div>
    <div class="mt-3">
      <%= render 'approve_button', order: @order %>
      <%= link_to 'Editar', edit_admin_order_path(@order), class: 'btn btn-outline-primary' %>
      <%= link_to 'Excluir', admin_order_path(@order), method: :delete, data: { confirm: 'Tem certeza?' }, class: 'btn btn-outline-danger' %>
      <%= link_to 'Voltar', admin_orders_path, class: 'btn btn-secondary' %>
    </div>
  </div>
</div>
